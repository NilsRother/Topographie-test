<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Europa GIS Profi-Karte</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        #map { height: 100vh; width: 100%; background: #eef2f3; z-index: 1; }
        
        /* UI ELEMENTE */
        .leaflet-control-layers { 
            border-radius: 8px !important; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
            padding: 10px !important;
        }

        /* POPUP DESIGN */
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .cat-header { font-size: 0.7em; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 2px; }
        .item-name { font-size: 1.1em; font-weight: 600; color: #333; }

        /* QUIZ PANEL */
        #quiz-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 2000; background: white; padding: 20px 30px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25); text-align: center; min-width: 320px;
        }
        .quiz-btn {
            background: #1a73e8; color: white; border: none; padding: 10px 24px;
            border-radius: 24px; cursor: pointer; font-size: 15px; font-weight: 600;
            transition: background 0.2s; margin: 0 5px;
        }
        .quiz-btn:hover { background: #1557b0; }
        .quiz-btn.stop { background: #ea4335; color: white; }

        #quiz-question { font-size: 1.2em; font-weight: bold; color: #202124; margin: 8px 0; }
        #quiz-feedback { height: 24px; font-weight: 600; font-size: 0.95em; margin-bottom: 5px; }
        
        /* Loading Spinner */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px;
            z-index: 3000; font-weight: bold; box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="loading">üì° Lade GIS-Daten...</div>

<div id="quiz-panel">
    <div id="quiz-start-view">
        <h3 style="margin:0 0 10px 0; color:#444;">GIS Topographie Quiz</h3>
        <p style="font-size:0.9em; color:#666; margin-bottom:15px;">Finde die Objekte auf der Karte.</p>
        <button class="quiz-btn" onclick="startQuiz()">Quiz Starten</button>
    </div>
    
    <div id="quiz-game-view" style="display:none;">
        <div id="quiz-score" style="color:#777; font-size:0.85em;">Punkte: 0</div>
        <div id="quiz-question">Bereit?</div>
        <div id="quiz-feedback"></div>
        <div style="margin-top:10px;">
            <button class="quiz-btn stop" onclick="stopQuiz()">Beenden</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- 1. SETUP ---
    var map = L.map('map', { zoomControl: false }).setView([50.0, 10.0], 5);
    L.control.zoom({ position: 'topright' }).addTo(map);

    var openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17, attribution: '¬© OpenTopoMap'
    }).addTo(map);

    var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles ¬© Esri'
    });

    var lgGebirge = L.layerGroup();
    var lgFluesse = L.layerGroup();
    var lgStaedte = L.layerGroup();
    var lgLaender = L.layerGroup();

    // --- 2. STYLING (Google Maps GIS Style) ---

    // Style f√ºr L√§nder
    const styleCountry = { color: "#999", weight: 1, fillOpacity: 0, dashArray: '4, 4' };

    // Style f√ºr Fl√ºsse (Doppel-Linie Effekt)
    // GeoJSON erlaubt keine zwei Styles direkt, daher der Trick sp√§ter im Code
    const styleRiverBorder = { color: '#406185', weight: 5, opacity: 0.8 };
    const styleRiverWater = { color: '#7FA8D7', weight: 2.5, opacity: 1 };
    
    // Style f√ºr Gebirge (Manuell definiert, da GIS-Daten f√ºr Gebirgsfl√§chen oft fehlen)
    const styleGebirge = { color: '#5d4037', weight: 2, fillColor: '#8d6e63', fillOpacity: 0.35 };

    // --- 3. DATEN CONFIG ---

    // √úbersetzungstabelle: GIS Name (Englisch) -> Quiz Name (Deutsch)
    // Nur Fl√ºsse, die hier stehen, werden auf der Karte angezeigt!
    const riverTranslation = {
        "Danube": "Donau",
        "Rhine": "Rhein",
        "Elbe": "Elbe",
        "Volga": "Wolga",
        "Loire": "Loire",
        "Po": "Po",
        "Thames": "Themse",
        "Seine": "Seine",
        "Tagus": "Tajo",
        "Douro": "Duero",
        "Ebro": "Ebro",
        "Oder": "Oder",
        "Vistula": "Weichsel",
        "Dnieper": "Dnipro",
        "Don": "Don",
        "Dniester": "Dnister",
        "Rhone": "Rh√¥ne",
        "Garonne": "Garonne",
        "Meuse": "Maas",
        "Weser": "Weser",
        "Glomma": "Glama"
    };

    let searchIndex = [];
    let quizActive = false;
    let quizPool = [];
    let currentItem = null;
    let score = 0;

    // --- 4. DATEN LADEN (FETCH) ---

    async function loadData() {
        try {
            // A. L√§ndergrenzen laden (Natural Earth 110m)
            const resCountries = await fetch('https://raw.githubusercontent.com/datasets/geo-boundaries-world-110m/master/countries.geojson');
            const dataCountries = await resCountries.json();
            L.geoJson(dataCountries, {
                style: styleCountry,
                interactive: false
            }).addTo(lgLaender);

            // B. Fl√ºsse laden (Natural Earth 50m - Detailreich!)
            const resRivers = await fetch('https://raw.githubusercontent.com/martynafford/natural-earth-geojson/master/50m_physical/ne_50m_rivers_lake_centerlines.json');
            const dataRivers = await resRivers.json();

            // C. Fl√ºsse verarbeiten
            // Wir m√ºssen jeden Fluss zweimal hinzuf√ºgen f√ºr den Rand-Effekt
            
            // Layer 1: Ufer (Dicker Rand)
            L.geoJson(dataRivers, {
                filter: filterRivers,
                style: styleRiverBorder,
                interactive: false
            }).addTo(lgFluesse);

            // Layer 2: Wasser (D√ºnner Kern & Interaktion)
            L.geoJson(dataRivers, {
                filter: filterRivers,
                style: styleRiverWater,
                onEachFeature: (feature, layer) => {
                    // Deutschen Namen holen
                    let deName = riverTranslation[feature.properties.name] || riverTranslation[feature.properties.name_en];
                    
                    // Unsichtbare Klickzone vergr√∂√üern (Leaflet Trick: dickerer transparenter Stroke bei Hover simulieren)
                    layer.quizData = { name: deName, type: "Fluss" };
                    layer.on('click', (e) => handleClick(e, layer));
                    
                    // Hover Effekt
                    layer.on('mouseover', () => { if(!quizActive) layer.setStyle({weight: 4, color: '#2980b9'}); });
                    layer.on('mouseout', () => { if(!quizActive) layer.setStyle(styleRiverWater); });

                    searchIndex.push({ name: deName, layer: layer, type: "Fluss", group: lgFluesse });
                }
            }).addTo(lgFluesse);

            document.getElementById('loading').style.display = 'none';

        } catch (error) {
            console.error("Fehler beim Laden der GIS Daten:", error);
            document.getElementById('loading').innerText = "Fehler beim Laden!";
        }
    }

    // Filter-Funktion: Nur europ√§ische Fl√ºsse aus der Liste zulassen
    function filterRivers(feature) {
        let name = feature.properties.name;
        let nameEn = feature.properties.name_en;
        // Check ob der Name in unserer √úbersetzungsliste steht
        return riverTranslation.hasOwnProperty(name) || riverTranslation.hasOwnProperty(nameEn);
    }

    // --- 5. MANUELLE OBJEKTE (Gebirge & St√§dte) ---
    // (Gebirge als Fl√§chen sind in einfachen GIS-Daten selten gut, daher behalten wir die guten Polygone)

    function addGebirge(coords, name) {
        let p = L.polygon(coords, styleGebirge);
        p.quizData = { name: name, type: "Gebirge" };
        p.on('click', (e) => handleClick(e, p));
        p.on('mouseover', () => { if(!quizActive) p.setStyle({fillOpacity: 0.6}); });
        p.on('mouseout', () => { if(!quizActive) p.setStyle(styleGebirge); });
        p.addTo(lgGebirge);
        searchIndex.push({ name: name, layer: p, type: "Gebirge", group: lgGebirge });
    }

    function addStadt(coord, name) {
        let m = L.circleMarker(coord, { radius: 6, color: '#333', weight: 2, fillColor: '#fff', fillOpacity: 1 });
        m.quizData = { name: name, type: "Stadt" };
        m.on('click', (e) => handleClick(e, m));
        m.addTo(lgStaedte);
        searchIndex.push({ name: name, layer: m, type: "Stadt", group: lgStaedte });
    }

    // Gebirge Daten
    addGebirge([[43.8,7.2], [45.0,6.5], [46.5,8.0], [47.5,9.5], [47.6,12.5], [47.5,14.5], [48.2,16.2], [47.0,15.0], [46.0,11.0], [44.2,7.5]], "Alpen");
    addGebirge([[43.3,-1.8], [42.8,0.0], [42.6,2.0], [42.4,3.2], [42.8,3.2], [43.1,1.5], [43.5,-1.5]], "Pyren√§en");
    addGebirge([[48.2,17.0], [49.5,19.5], [49.8,22.0], [48.5,24.5], [47.0,26.5], [45.5,26.8], [44.8,24.5], [45.5,22.0], [47.0,22.5], [48.0,20.0]], "Karpaten");
    addGebirge([[44.5,8.5], [44.0,11.0], [42.5,13.5], [40.5,16.0], [38.0,16.0], [39.5,15.0], [41.5,12.5], [43.5,9.5]], "Apenninen");
    addGebirge([[68.0,66.0], [66.0,65.0], [62.0,59.0], [59.0,59.0], [55.0,59.0], [51.0,58.0], [51.0,61.0], [55.0,61.5], [62.0,61.0], [67.0,67.5]], "Ural");
    addGebirge([[58.5,6.0], [61.0,7.5], [63.0,11.0], [68.0,18.0], [70.5,23.0], [69.5,26.0], [66.0,19.0], [61.5,12.0], [59.0,9.0]], "Skandinavisches Gebirge");

    // St√§dte Daten
    const cities = [
        {n: "Berlin", c: [52.52, 13.40]}, {n: "Paris", c: [48.85, 2.35]}, {n: "London", c: [51.50, -0.12]},
        {n: "Rom", c: [41.90, 12.49]}, {n: "Madrid", c: [40.41, -3.70]}, {n: "Moskau", c: [55.75, 37.61]},
        {n: "Athen", c: [37.98, 23.72]}, {n: "Wien", c: [48.20, 16.37]}, {n: "Warschau", c: [52.22, 21.01]}
    ];
    cities.forEach(c => addStadt(c.c, c.n));

    // --- 6. INITIALISIERUNG ---

    lgGebirge.addTo(map);
    lgFluesse.addTo(map);
    lgStaedte.addTo(map);
    lgLaender.addTo(map);

    L.control.layers(
        { "‚õ∞Ô∏è Topographie": openTopo, "üõ∞Ô∏è Satellit": esriSat }, 
        { "üèîÔ∏è Gebirge": lgGebirge, "„Ä∞Ô∏è Fl√ºsse (GIS)": lgFluesse, "üèôÔ∏è St√§dte": lgStaedte, "üè≥Ô∏è Grenzen": lgLaender }
    ).addTo(map);

    // Daten laden
    loadData();

    // --- 7. INTERAKTION & QUIZ ---

    function handleClick(e, layer) {
        if(quizActive) {
            checkAnswer(layer.quizData, layer);
        } else {
            let data = layer.quizData;
            L.popup().setLatLng(e.latlng)
                .setContent(`<div class="cat-header">${data.type}</div><div class="item-name">${data.name}</div>`)
                .openOn(map);
        }
    }

    function startQuiz() {
        quizPool = [];
        // Nur sichtbare Layer ins Quiz aufnehmen
        searchIndex.forEach(item => {
            if(map.hasLayer(item.group)) quizPool.push(item);
        });

        if(quizPool.length === 0) return alert("Bitte schalte Layer (z.B. Fl√ºsse) ein!");

        quizActive = true;
        score = 0;
        document.getElementById('quiz-start-view').style.display = 'none';
        document.getElementById('quiz-game-view').style.display = 'block';
        map.closePopup();
        nextQuestion();
    }

    function stopQuiz() {
        quizActive = false;
        document.getElementById('quiz-start-view').style.display = 'block';
        document.getElementById('quiz-game-view').style.display = 'none';
        resetStyles();
    }

    function nextQuestion() {
        if(quizPool.length === 0) {
            document.getElementById('quiz-question').innerText = "üéâ Quiz beendet!";
            return;
        }
        document.getElementById('quiz-feedback').innerText = "";
        
        let idx = Math.floor(Math.random() * quizPool.length);
        currentItem = quizPool[idx];
        document.getElementById('quiz-question').innerText = `Wo ist: ${currentItem.name}?`;
    }

    function checkAnswer(data, layer) {
        let feedback = document.getElementById('quiz-feedback');
        
        if(data.name === currentItem.name) {
            feedback.innerHTML = `<span style="color:green">Richtig! ‚úì</span>`;
            score++;
            document.getElementById('quiz-score').innerText = `Punkte: ${score}`;
            
            // Highlight Richtig
            if(layer.setStyle) layer.setStyle({color: '#2ecc71', fillColor: '#2ecc71'});
            
            quizPool = quizPool.filter(i => i.name !== currentItem.name);
            setTimeout(nextQuestion, 1000);
        } else {
            feedback.innerHTML = `<span style="color:red">Falsch, das ist: ${data.name}</span>`;
            // Rot blinken
            if(layer.setStyle) {
                let oldColor = layer.options.color;
                layer.setStyle({color: '#e74c3c'});
                setTimeout(() => layer.setStyle({color: oldColor}), 1000);
            }
        }
    }

    function resetStyles() {
        lgFluesse.eachLayer(l => {
            // Check ob es das "Wasser" Layer ist (hat das quizData property)
            if(l.quizData) l.setStyle(styleRiverWater); 
        });
        lgGebirge.eachLayer(l => l.setStyle(styleGebirge));
        lgStaedte.eachLayer(l => l.setStyle({color:'#333', fillColor:'#fff'}));
    }

</script>
</body>
</html>
