<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Europa Geographie Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: #aad3df; }
        
        /* --- 1. GRUNDLAYOUT --- */
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Hilfsklassen */
        .hidden { display: none !important; }
        .flex { display: flex; }

        /* --- 2. HAUPTMEN√ú BUTTON --- */
        #menu-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 3000;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #menu-btn:hover { transform: scale(1.1); }

        /* --- 3. DAS EINSTELLUNGS-MEN√ú (OVERLAY) --- */
        #main-menu {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            z-index: 4000;
            display: none; /* Standardm√§√üig versteckt */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .menu-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .menu-title { font-size: 1.8rem; font-weight: 800; color: #2c3e50; margin-bottom: 5px; }
        .menu-subtitle { color: #7f8c8d; margin-bottom: 25px; }

        /* Layer Toggle Schalter im Men√º */
        .layer-toggles { text-align: left; margin-bottom: 25px; background: #f8f9fa; padding: 15px; border-radius: 10px; }
        .toggle-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; }
        .toggle-item input { margin-right: 10px; transform: scale(1.3); cursor: pointer; }
        .toggle-label { font-size: 1rem; color: #333; }

        .mode-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-classic { background: #f39c12; color: white; }
        .btn-exam { background: #3498db; color: white; }
        .btn-close { background: #95a5a6; color: white; margin-top: 10px; }
        .mode-btn:hover { transform: scale(1.02); opacity: 0.9; }

        /* --- 4. SUCHLEISTE (F√ºr den Erkundungsmodus) --- */
        #search-container {
            position: absolute;
            top: 20px;
            left: 80px; /* Rechts neben dem Men√º Button */
            z-index: 2000;
            width: calc(100% - 100px);
            max-width: 350px;
        }
        #search-input {
            width: 100%; padding: 12px 20px; border: none; border-radius: 30px;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); outline: none;
        }
        #search-results {
            background: white; margin-top: 5px; border-radius: 10px; max-height: 300px; overflow-y: auto; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .search-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background: #f0f8ff; }

        /* --- 5. UI: KLASSISCHES QUIZ (Panel unten) --- */
        #classic-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 2000; background: white; padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); text-align: center; min-width: 300px;
        }
        .classic-question { font-size: 1.3em; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .classic-feedback { font-weight: bold; height: 24px; }
        .correct { color: #27ae60; } .wrong { color: #c0392b; }

        /* --- 6. UI: PR√úFUNGS-MODUS (App Style) --- */
        #exam-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.98);
            border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 2000;
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
        }
        .exam-progress { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
        .exam-bar { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .exam-btn {
            background: white; border: 2px solid #e0e0e0; padding: 10px; border-radius: 8px;
            font-weight: 600; color: #555; cursor: pointer;
        }
        .exam-btn.correct { background: #2ecc71; color: white; border-color: #27ae60; }
        .exam-btn.wrong { background: #e74c3c; color: white; border-color: #c0392b; }

        /* Stop Button (Global f√ºr beide Quizze) */
        .stop-btn {
            position: absolute; top: 20px; right: 20px; z-index: 3000;
            background: #e74c3c; color: white; border: none; padding: 8px 15px;
            border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

<button id="menu-btn" onclick="toggleMenu()">‚öôÔ∏è</button>

<div id="search-container">
    <input type="text" id="search-input" placeholder="üîç Suche nach Ort...">
    <div id="search-results"></div>
</div>

<button id="global-stop-btn" class="stop-btn hidden" onclick="stopAnyQuiz()">Beenden ‚úï</button>

<div id="main-menu">
    <div class="menu-card">
        <h2 class="menu-title">Geographie Master</h2>
        <p class="menu-subtitle">W√§hle deinen Modus & Layer</p>
        
        <div class="layer-toggles">
            <div style="font-size:0.8em; color:#999; margin-bottom:10px; text-transform:uppercase; font-weight:bold;">Sichtbare Ebenen</div>
            <label class="toggle-item"><input type="checkbox" checked onchange="toggleLayer('gebirge', this)"> <span class="toggle-label">üèîÔ∏è Gebirge</span></label>
            <label class="toggle-item"><input type="checkbox" checked onchange="toggleLayer('fluesse', this)"> <span class="toggle-label">„Ä∞Ô∏è Fl√ºsse</span></label>
            <label class="toggle-item"><input type="checkbox" checked onchange="toggleLayer('staedte', this)"> <span class="toggle-label">üèôÔ∏è St√§dte</span></label>
            <label class="toggle-item"><input type="checkbox" checked onchange="toggleLayer('tiefland', this)"> <span class="toggle-label">üåø Tiefl√§nder</span></label>
        </div>

        <button class="mode-btn btn-classic" onclick="startMode('classic')">üìç Klassisches Quiz<br><span style="font-size:0.8em; font-weight:normal;">(Finde den Ort auf der Karte)</span></button>
        <button class="mode-btn btn-exam" onclick="startMode('exam')">üéì Pr√ºfungs-Modus<br><span style="font-size:0.8em; font-weight:normal;">(Multiple Choice Fragen)</span></button>
        <button class="mode-btn btn-close" onclick="toggleMenu()">Karte erkunden</button>
    </div>
</div>

<div id="classic-panel" class="hidden">
    <div id="classic-score" style="color:#7f8c8d; font-size:0.9em;">Punkte: 0</div>
    <div class="classic-question" id="classic-question">Wo liegt...?</div>
    <div class="classic-feedback" id="classic-feedback"></div>
    <button onclick="skipClassic()" style="margin-top:10px; background:#95a5a6; border:none; color:white; padding:5px 15px; border-radius:15px; cursor:pointer;">√úberspringen</button>
</div>

<div id="exam-panel" class="hidden">
    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
        <span id="exam-counter">Frage 1/10</span>
        <span id="exam-score-txt">0%</span>
    </div>
    <div class="exam-progress"><div class="exam-bar" id="exam-bar"></div></div>
    <div style="text-align:center; font-weight:bold; margin-top:10px; font-size:1.1em;" id="exam-question-text">Wie hei√üt dieser Ort?</div>
    <div class="exam-grid" id="exam-options"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- STATE MANAGEMENT ---
    const MODES = { EXPLORE: 'explore', CLASSIC: 'classic', EXAM: 'exam' };
    let currentMode = MODES.EXPLORE;
    let map;
    
    // Daten Container
    let searchIndex = [];
    
    // Layer Gruppen
    const layers = {
        gebirge: L.layerGroup(),
        fluesse: L.layerGroup(),
        staedte: L.layerGroup(),
        tiefland: L.layerGroup(),
        laender: L.layerGroup() // Immer an, aber im Hintergrund
    };

    // --- INITIALISIERUNG ---
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([50.0, 15.0], 4);
        
        // Base Layers
        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, attribution: '¬© OpenTopoMap' }).addTo(map);
        
        // Layer hinzuf√ºgen
        Object.values(layers).forEach(l => l.addTo(map));
        
        // L√§ndergrenzen laden
        fetch('https://raw.githubusercontent.com/datasets/geo-boundaries-world-110m/master/countries.geojson')
            .then(res => res.json())
            .then(data => L.geoJson(data, { 
                style: { color: "#555", weight: 1, fillOpacity: 0, dashArray: '5, 5' }, 
                interactive: false 
            }).addTo(layers.laender));

        renderData();
    }

    // --- DATEN & RENDERING ---
    // (Styles)
    const sGebirge = { color: '#8B4513', fillColor: '#A0522D', weight: 1, fillOpacity: 0.4 };
    const sTiefland = { color: '#228B22', fillColor: '#90EE90', weight: 1, fillOpacity: 0.3 };
    const sFluss = { color: '#1e3799', weight: 3, opacity: 0.8 };
    const sStadt = { radius: 6, color: '#000', fillColor: '#fff', weight: 1.5, fillOpacity: 1 };
    
    // DATEN (Gleiche Datenbasis)
    const dGebirge = [
        {n: "Skandinavisches Gebirge", c: [[58.5,6.0], [61.0,7.5], [63.0,11.0], [68.0,18.0], [70.5,23.0], [69.5,26.0], [66.0,19.0], [61.5,12.0], [59.0,9.0]]},
        {n: "Alpen", c: [[43.8,7.2], [45.0,6.5], [46.5,8.0], [47.5,9.5], [47.6,12.5], [47.5,14.5], [48.2,16.2], [47.0,15.0], [46.0,11.0], [44.2,7.5]]},
        {n: "Pyren√§en", c: [[43.3,-1.8], [42.8,0.0], [42.6,2.0], [42.4,3.2], [42.8,3.2], [43.1,1.5], [43.5,-1.5]]},
        {n: "Karpaten", c: [[48.2,17.0], [49.5,19.5], [49.8,22.0], [48.5,24.5], [47.0,26.5], [45.5,26.8], [44.8,24.5], [45.5,22.0], [47.0,22.5], [48.0,20.0]]},
        {n: "Ural", c: [[68.0,66.0], [66.0,65.0], [62.0,59.0], [59.0,59.0], [55.0,59.0], [51.0,58.0], [51.0,61.0], [55.0,61.5], [62.0,61.0], [67.0,67.5]]}
    ];
    const dFluesse = [
        {n: "Donau", c: [[48.0,8.2], [48.5,10.0], [48.4,13.5], [48.2,16.4], [47.8,19.0], [45.8,18.8], [44.8,20.5], [44.5,22.5], [43.7,25.0], [44.2,27.5], [45.2,29.6]]},
        {n: "Rhein", c: [[46.6,9.4], [47.6,9.5], [47.5,7.6], [48.5,7.9], [50.0,8.3], [50.5,7.3], [51.8,6.0], [51.9,4.1]]},
        {n: "Wolga", c: [[57.2,32.5], [56.8,35.5], [57.8,38.5], [56.5,43.5], [56.0,46.0], [56.2,49.5], [55.0,49.0], [53.2,49.0], [52.0,47.5], [51.0,46.0], [48.7,44.5], [47.0,46.5], [45.8,48.0]]},
        {n: "Elbe", c: [[50.7,15.6], [51.0,14.0], [51.5,13.5], [52.2,12.0], [53.0,11.0], [53.5,9.5], [53.9,8.6]]},
        {n: "Themse", c: [[51.7,-2.0], [51.6,-1.0], [51.5,-0.1], [51.5,0.7]]}
    ];
    const dStaedte = [
        {n: "Berlin", c: [52.5200, 13.4050]}, {n: "Paris", c: [48.8566, 2.3522]}, {n: "London", c: [51.5074, -0.1278]},
        {n: "Rom", c: [41.9028, 12.4964]}, {n: "Madrid", c: [40.4168, -3.7038]}, {n: "Moskau", c: [55.7558, 37.6173]}
    ];
    const dTiefland = [
        {n: "Norddt. Tiefland", c: [[52.0,6.0], [54.0,7.5], [54.5,13.5], [52.5,14.5], [51.5,11.0]]},
        {n: "Poebene", c: [[44.8,7.5], [45.5,9.5], [45.5,12.5], [44.5,12.0]]}
    ];

    function addToMap(group, type, data, isLine = false, isPoint = false) {
        data.forEach(item => {
            let layer;
            if (isPoint) {
                layer = L.circleMarker(item.c, sStadt);
            } else if (isLine) {
                // Unsichtbarer dicker Bereich f√ºr Klickbarkeit bei Fl√ºssen
                layer = L.featureGroup([
                    L.polyline(item.c, sFluss),
                    L.polyline(item.c, {weight: 20, opacity: 0})
                ]);
            } else {
                let style = type === "Gebirge" ? sGebirge : sTiefland;
                layer = L.polygon(item.c, style);
            }

            // Metadaten anh√§ngen
            layer.quizData = { name: item.n, type: type };
            
            // Zentraler Click Handler
            layer.on('click', (e) => handleMapClick(e, layer));
            
            layer.addTo(group);
            
            // In Suchindex aufnehmen (wir merken uns die "Hauptlayer" f√ºr Styles)
            let visualLayer = (isLine) ? layer.getLayers()[0] : layer;
            searchIndex.push({ 
                name: item.n, 
                type: type, 
                layer: visualLayer, // Zum F√§rben
                groupLayer: layer,  // Zum Zoomen
                parentGroup: group 
            });
        });
    }

    function renderData() {
        addToMap(layers.gebirge, "Gebirge", dGebirge);
        addToMap(layers.fluesse, "Fluss", dFluesse, true);
        addToMap(layers.staedte, "Stadt", dStaedte, false, true);
        addToMap(layers.tiefland, "Landschaft", dTiefland);
    }

    // --- INTERAKTIONS-LOGIK ---

    function handleMapClick(e, layerGroupOrLayer) {
        let data = layerGroupOrLayer.quizData;

        if (currentMode === MODES.EXPLORE) {
            // Popup anzeigen
            L.popup()
                .setLatLng(e.latlng)
                .setContent(`<b>${data.type}</b><br>${data.name}`)
                .openOn(map);
        } 
        else if (currentMode === MODES.CLASSIC) {
            checkClassicAnswer(data, layerGroupOrLayer);
        }
        // Im Exam Modus sind Klicks auf die Karte deaktiviert
    }

    // --- MEN√ú & STEUERUNG ---

    function toggleMenu() {
        let el = document.getElementById('main-menu');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    function toggleLayer(key, checkbox) {
        if (checkbox.checked) {
            map.addLayer(layers[key]);
        } else {
            map.removeLayer(layers[key]);
        }
    }

    function startMode(mode) {
        currentMode = mode;
        toggleMenu(); // Men√º schlie√üen
        
        // UI Reset
        document.getElementById('search-container').classList.add('hidden');
        document.getElementById('menu-btn').classList.add('hidden');
        document.getElementById('global-stop-btn').classList.remove('hidden');
        map.closePopup();
        resetStyles();

        if (mode === MODES.CLASSIC) {
            initClassicQuiz();
        } else if (mode === MODES.EXAM) {
            initExamQuiz();
        }
    }

    function stopAnyQuiz() {
        currentMode = MODES.EXPLORE;
        
        // UI Reset
        document.getElementById('classic-panel').classList.add('hidden');
        document.getElementById('exam-panel').classList.add('hidden');
        document.getElementById('search-container').classList.remove('hidden');
        document.getElementById('menu-btn').classList.remove('hidden');
        document.getElementById('global-stop-btn').classList.add('hidden');
        
        resetStyles();
        map.setView([50.0, 15.0], 4);
    }

    function resetStyles() {
        searchIndex.forEach(item => {
            let l = item.layer;
            if (item.type === "Stadt") l.setStyle(sStadt);
            else if (item.type === "Fluss") l.setStyle(sFluss);
            else if (item.type === "Gebirge") l.setStyle(sGebirge);
            else l.setStyle(sTiefland);
        });
    }

    // --- 1. LOGIK: KLASSISCHES QUIZ (FINDE X) ---
    
    let classicPool = [];
    let classicTarget = null;
    let classicScore = 0;

    function initClassicQuiz() {
        document.getElementById('classic-panel').classList.remove('hidden');
        classicPool = getVisibleItems();
        classicScore = 0;
        nextClassicQuestion();
    }

    function nextClassicQuestion() {
        if (classicPool.length === 0) {
            document.getElementById('classic-question').innerText = "Alle gefunden!";
            return;
        }
        let idx = Math.floor(Math.random() * classicPool.length);
        classicTarget = classicPool[idx];
        document.getElementById('classic-question').innerText = `Wo ist: ${classicTarget.name}?`;
        document.getElementById('classic-feedback').innerText = "";
        document.getElementById('classic-score').innerText = "Punkte: " + classicScore;
    }

    function checkClassicAnswer(clickedData, layerObj) {
        if (!classicTarget) return;
        
        // Hole den visuellen Layer zum F√§rben
        let visualLayer = (clickedData.type === 'Fluss') ? layerObj.getLayers()[0] : layerObj;

        if (clickedData.name === classicTarget.name) {
            document.getElementById('classic-feedback').innerHTML = "<span class='correct'>Richtig!</span>";
            visualLayer.setStyle({ color: '#2ecc71', fillColor: '#2ecc71' }); // Gr√ºn
            classicScore++;
            classicPool = classicPool.filter(i => i.name !== classicTarget.name);
            setTimeout(nextClassicQuestion, 1000);
        } else {
            document.getElementById('classic-feedback').innerHTML = "<span class='wrong'>Das ist " + clickedData.name + "</span>";
        }
    }
    
    function skipClassic() {
        // Zeige L√∂sung (Magenta)
        classicTarget.layer.setStyle({ color: '#ff00ff', weight: 5 });
        classicPool = classicPool.filter(i => i.name !== classicTarget.name);
        setTimeout(() => {
            resetStyles(); // Farbe weg
            nextClassicQuestion();
        }, 1500);
    }

    // --- 2. LOGIK: PR√úFUNGS-MODUS (MULTIPLE CHOICE) ---

    let examPool = [];
    let examIndex = 0;
    let examCorrect = 0;
    let examActive = false;

    function initExamQuiz() {
        document.getElementById('exam-panel').classList.remove('hidden');
        let visible = getVisibleItems();
        // Mische und nimm max 10
        examPool = visible.sort(() => 0.5 - Math.random()).slice(0, 10);
        examIndex = 0;
        examCorrect = 0;
        examActive = true;
        loadExamQuestion();
    }

    function loadExamQuestion() {
        if (examIndex >= examPool.length) {
            // Ende
            document.getElementById('exam-question-text').innerText = `Ergebnis: ${examCorrect} von ${examPool.length}`;
            document.getElementById('exam-options').innerHTML = '<button class="exam-btn" onclick="stopAnyQuiz()">Zur√ºck zur Karte</button>';
            return;
        }

        let item = examPool[examIndex];
        
        // UI
        document.getElementById('exam-counter').innerText = `Frage ${examIndex + 1}/${examPool.length}`;
        document.getElementById('exam-bar').style.width = ((
